name: Continuous Delivery - Release

on:
  create:
    branches:
      - 'release*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install Dependencies
        run: npm install

      - name: Run Unit Tests
        run: npm test -- --coverage

      - name: Check Test Coverage
        run: |
          totalStatements=$(jq -r '[.[] | .statementMap | length] | add' coverage/coverage-final.json)
          coveredStatements=$(jq -r '[.[] | .s[]] | add' coverage/coverage-final.json)
          coveragePercentage=$(bc -l <<< "scale=2; ($coveredStatements / $totalStatements) * 100")
          echo "Total statements: $totalStatements"
          echo "Covered statements: $coveredStatements"
          echo "Coverage is $coveragePercentage%"
          if (( $(bc -l <<< "$coveragePercentage < 70") )); then
            echo "Coverage is below threshold"
            exit 1
          fi

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-org-id: ${{ secrets.VERCEL_SCOPE }}
          vercel_git_branch: 'dev'
